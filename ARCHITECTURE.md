# IBEX Platform Architecture

## البنية المقترحة للمنصة

### هيكل المجلدات

```
ibex27/
├── src/
│   ├── main/              # Electron Main Process (Backend)
│   │   ├── schema.ts     # قاعدة البيانات - جميع الجداول
│   │   ├── db.ts         # اتصال قاعدة البيانات
│   │   ├── auth.ts       # نظام المصادقة
│   │   ├── stores.ts     # إدارة المتاجر
│   │   ├── customers.ts  # إدارة العملاء
│   │   └── ...
│   ├── preload/          # Electron Preload Scripts (Bridge)
│   │   └── index.ts      # جسر آمن بين Renderer و Main
│   ├── renderer/         # React UI (Frontend)
│   │   └── src/
│   │       ├── admin/    # لوحة تحكم مدير المنصة
│   │       ├── merchant/ # لوحة تحكم التاجر
│   │       ├── cashier/  # لوحة تحكم الكاشير
│   │       ├── customer/ # واجهة العميل (Web)
│   │       └── components/
│   │           └── common/ # مكونات مشتركة
│   └── shared/           # كود مشترك بين Main و Renderer
│       ├── types/        # TypeScript Types
│       └── utils/        # دوال مساعدة
```

## نظام الأدوار (Roles)

### 1. Platform Admin (مدير المنصة)
- إدارة جميع التجار والمتاجر
- إدارة الاشتراكات
- إحصائيات شاملة
- صلاحيات كاملة

### 2. Merchant (التاجر)
- إدارة متجره الخاص
- إدارة العملاء والكاشير
- إدارة المنتجات والمبيعات
- الموافقة على طلبات التسجيل وتعبئة الرصيد

### 3. Cashier (الكاشير)
- تنفيذ المبيعات
- إدارة المخزون (حسب الصلاحيات)
- عرض التقارير (حسب الصلاحيات)

### 4. Customer (العميل)
- تسجيل الدخول من رابط المتجر
- عرض رصيده في المتجر
- طلب تعبئة الرصيد
- تصفح المنتجات والعروض
- عرض سجل العمليات

## قاعدة البيانات

### الجداول الأساسية

#### 1. `currencies` - العملات
- دعم تعدد العملات
- سعر الصرف مقابل العملة الأساسية

#### 2. `users` - المستخدمون
- جميع الأدوار في جدول واحد
- `storeId` للتجار والكاشير
- `subscriptionStatus` للاشتراكات

#### 3. `stores` - المتاجر
- `slug` فريد للروابط
- `bankAccounts` (JSONB) - الحسابات المصرفية
- `contactInfo` (JSONB) - معلومات التواصل
- `settings` (JSONB) - إعدادات المتجر

#### 4. `customers` - العملاء
- `password` مشفر
- `registrationStatus` - حالة التسجيل
- `balance` - رصيد عام

#### 5. `customer_store_relations` - علاقة العميل بالمتجر
- رصيد العميل في كل متجر
- تاريخ التسجيل

#### 6. `customer_balance_requests` - طلبات تعبئة الرصيد
- البنك، المبلغ، الرقم المرجعي
- حالة الطلب (pending/approved/rejected)

#### 7. `customer_transactions` - سجل العمليات
- الفواتير، الإيداعات، المدفوعات الآجلة

#### 8. `store_offers` - العروض والإعلانات
- عرض العروض للعملاء

### Soft Delete
جميع الجداول الأساسية تحتوي على `deletedAt` للحذف الناعم (Soft Delete) لحماية السجلات المالية.

### Multi-Store Support
جميع الجداول المرتبطة بمتجر تحتوي على `storeId`:
- `products`
- `sales`
- `expenses`
- `duePayments`
- `rents`
- `rentItems`
- `presences`
- `salaries`

## نظام المصادقة

### للعملاء
1. **التسجيل**: من رابط المتجر (`/customer/store/:slug/register`)
2. **طلب التسجيل**: يتم إرساله تلقائياً كـ `pending`
3. **الموافقة**: التاجر يوافق/يرفض من لوحة التحكم
4. **تسجيل الدخول**: رقم الجوال + كلمة المرور

### للتجار والكاشير
- تسجيل الدخول بالبريد الإلكتروني + كلمة المرور
- الصلاحيات حسب الدور

## واجهة العميل (Customer Portal)

### الصفحات
1. **تسجيل جديد** (`/customer/store/:slug/register`)
   - الاسم الرباعي
   - رقم الجوال (9 أرقام)
   - كلمة المرور
   - إرسال طلب تلقائياً

2. **تسجيل دخول** (`/customer/login`)
   - رقم الجوال
   - كلمة المرور

3. **لوحة التحكم** (`/customer/dashboard`)
   - قائمة المتاجر المسجل فيها
   - بطاقة لكل متجر

4. **تفاصيل المتجر** (`/customer/store/:storeId`)
   - بطاقة الرصيد
   - طلب تعبئة الرصيد
   - سجل العمليات
   - تصفح المنتجات
   - العروض والإعلانات
   - معلومات التواصل

## المكونات المشتركة

### `src/shared/types/`
- تعريفات TypeScript لجميع الأنواع
- `User`, `Store`, `Customer`, `Transaction`, etc.

### `src/shared/utils/`
- `currency.ts` - تنسيق العملات والتحويل
- `validation.ts` - التحقق من البيانات

### `src/renderer/src/components/common/`
- `Button.tsx` - زر موحد
- `Input.tsx` - حقل إدخال موحد
- مكونات أخرى مشتركة

## الخطوات التالية

1. ✅ تحديث `schema.ts` - تم
2. ✅ إنشاء `shared/types` و `shared/utils` - تم
3. ✅ إنشاء مكونات مشتركة - تم
4. ⏳ تحديث `preload/index.ts` لإضافة IPC handlers الجديدة
5. ⏳ إنشاء handlers في `main/` للعملاء والمتاجر
6. ⏳ إنشاء واجهة العميل (Customer Portal)
7. ⏳ تحديث لوحة تحكم التاجر
8. ⏳ إنشاء لوحة تحكم مدير المنصة

